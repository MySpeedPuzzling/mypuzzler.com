---
import WidgetWrapper from "./WidgetWrapper.astro";
import { personalBestProgress } from "../data/mock-data";

// SVG dimensions
const w = 500;
const h = 220;
const padLeft = 55;
const padRight = 20;
const padTop = 20;
const padBottom = 40;
const chartW = w - padLeft - padRight;
const chartH = h - padTop - padBottom;

const data = personalBestProgress;
const maxMin = Math.max(...data.map(d => d.minutes));
const minMin = Math.min(...data.map(d => d.minutes));
const range = maxMin - minMin || 1;

// Scale points - Y is inverted (lower time = higher on chart = better)
const points = data.map((d, i) => ({
  x: padLeft + (i / (data.length - 1)) * chartW,
  y: padTop + ((d.minutes - minMin) / range) * chartH, // lower time at top
  ...d,
}));

// Smooth line path
const linePath = points.map((p, i) => (i === 0 ? `M ${p.x},${p.y}` : `L ${p.x},${p.y}`)).join(" ");

// Area fill path
const areaPath = `${linePath} L ${points[points.length - 1].x},${padTop + chartH} L ${points[0].x},${padTop + chartH} Z`;

// Y-axis labels (time in minutes) - show 4 ticks
const yTicks = 4;
const yLabels = Array.from({ length: yTicks + 1 }, (_, i) => {
  const val = minMin + (range * i) / yTicks;
  const mins = Math.floor(val);
  return {
    y: padTop + (i / yTicks) * chartH,
    label: `${mins}m`,
  };
});

// Grid lines
const gridLines = yLabels.map(t => t.y);
---

<WidgetWrapper title="Personal Best · 500pc Solo" moreLink="https://myspeedpuzzling.com/player/simona-mikesova/results" moreText="See all times →">
  <!-- Summary row -->
  <div class="mb-4">
    <span class="time-display text-2xl font-bold text-slate-800">{data[data.length - 1].label}</span>
    <span class="text-xs text-slate-400 ml-1">current PB</span>
  </div>

  <!-- SVG Chart -->
  <svg viewBox={`0 0 ${w} ${h}`} class="w-full" preserveAspectRatio="xMidYMid meet">
    <!-- Grid lines -->
    {gridLines.map(y => (
      <line x1={padLeft} y1={y} x2={w - padRight} y2={y} stroke="#f1f5f9" stroke-width="1" />
    ))}

    <!-- Y-axis labels -->
    {yLabels.map(t => (
      <text x={padLeft - 8} y={t.y + 4} text-anchor="end" fill="#94a3b8" font-size="11" font-family="Inter, sans-serif">{t.label}</text>
    ))}

    <!-- Area gradient -->
    <defs>
      <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#EC726F" stop-opacity="0.2" />
        <stop offset="100%" stop-color="#EC726F" stop-opacity="0.02" />
      </linearGradient>
    </defs>
    <path d={areaPath} fill="url(#areaGrad)" />

    <!-- Line -->
    <path d={linePath} fill="none" stroke="#EC726F" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />

    <!-- Data points -->
    {points.map((p, i) => (
      <g>
        <circle cx={p.x} cy={p.y} r="4" fill="#EC726F" stroke="white" stroke-width="2" />
      </g>
    ))}

    <!-- X-axis labels -->
    {points.map((p, i) => {
      // Show every other label on small sets, or skip some on large
      const show = i === 0 || i === points.length - 1 || i % 2 !== 0;
      return show ? (
        <text x={p.x} y={h - 8} text-anchor="middle" fill="#94a3b8" font-size="10" font-family="Inter, sans-serif">{p.month}</text>
      ) : null;
    })}

    <!-- First and last value labels -->
    <text x={points[0].x} y={points[0].y - 10} text-anchor="start" fill="#94a3b8" font-size="10" font-family="JetBrains Mono, monospace">{data[0].label}</text>
    <text x={points[points.length - 1].x} y={points[points.length - 1].y - 10} text-anchor="end" fill="#EC726F" font-size="11" font-weight="600" font-family="JetBrains Mono, monospace">{data[data.length - 1].label}</text>
  </svg>
</WidgetWrapper>
