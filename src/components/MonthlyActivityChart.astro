---
import WidgetWrapper from "./WidgetWrapper.astro";
import { monthlyActivity } from "../data/mock-data";

// SVG dimensions
const w = 500;
const h = 220;
const padLeft = 40;
const padRight = 20;
const padTop = 10;
const padBottom = 40;
const chartW = w - padLeft - padRight;
const chartH = h - padTop - padBottom;

const data = monthlyActivity;
const maxPuzzles = Math.max(...data.map(d => d.puzzles));

const slotWidth = chartW / data.length;
const barWidth = Math.min(slotWidth * 0.5, 24);

const bars = data.map((d, i) => {
  const barH = (d.puzzles / maxPuzzles) * chartH;
  const slotCenter = padLeft + i * slotWidth + slotWidth / 2;
  return {
    x: slotCenter - barWidth / 2,
    y: padTop + chartH - barH,
    cx: slotCenter,
    w: barWidth,
    h: barH,
    ...d,
  };
});

// Y-axis ticks
const yTicks = [0, Math.round(maxPuzzles / 3), Math.round((maxPuzzles * 2) / 3), maxPuzzles];
---

<WidgetWrapper title="Monthly Activity" moreLink="https://myspeedpuzzling.com/player/simona-mikesova/activity" moreText="View all â†’">
  <!-- Summary row -->
  <div class="flex items-baseline gap-4 mb-4">
    <div>
      <span class="font-display text-2xl font-bold text-slate-800">{data.reduce((s, d) => s + d.puzzles, 0)}</span>
      <span class="text-xs text-slate-400 ml-1">puzzles in 11 months</span>
    </div>
    <div>
      <span class="font-display text-lg font-bold text-slate-600">{data.reduce((s, d) => s + d.hours, 0)}h</span>
      <span class="text-xs text-slate-400 ml-1">total time</span>
    </div>
  </div>

  <!-- SVG Chart -->
  <svg viewBox={`0 0 ${w} ${h}`} class="w-full" preserveAspectRatio="xMidYMid meet">
    <!-- Grid lines -->
    {yTicks.map(val => {
      const y = padTop + chartH - (val / maxPuzzles) * chartH;
      return (
        <g>
          <line x1={padLeft} y1={y} x2={w - padRight} y2={y} stroke="#f1f5f9" stroke-width="1" />
          <text x={padLeft - 8} y={y + 4} text-anchor="end" fill="#94a3b8" font-size="11" font-family="Inter, sans-serif">{val}</text>
        </g>
      );
    })}

    <!-- Bars -->
    {bars.map((bar) => (
      <g>
        <rect
          x={bar.x}
          y={bar.y}
          width={bar.w}
          height={bar.h}
          rx="4"
          fill="#EC726F"
          opacity={bar.puzzles === maxPuzzles ? "1" : "0.6"}
        />
        <!-- Value on top of tallest bars -->
        {bar.puzzles >= maxPuzzles * 0.8 && (
          <text x={bar.cx} y={bar.y - 6} text-anchor="middle" fill="#EC726F" font-size="11" font-weight="600" font-family="Inter, sans-serif">{bar.puzzles}</text>
        )}
        <!-- Month label -->
        <text x={bar.cx} y={h - 10} text-anchor="middle" fill="#94a3b8" font-size="10" font-family="Inter, sans-serif">{bar.month}</text>
      </g>
    ))}
  </svg>
</WidgetWrapper>
