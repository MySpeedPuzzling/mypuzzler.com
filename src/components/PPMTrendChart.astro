---
import WidgetWrapper from "./WidgetWrapper.astro";
import { ppmTrend } from "../data/mock-data";

// SVG dimensions
const w = 500;
const h = 220;
const padLeft = 45;
const padRight = 20;
const padTop = 20;
const padBottom = 40;
const chartW = w - padLeft - padRight;
const chartH = h - padTop - padBottom;

const data = ppmTrend;
const maxPPM = Math.max(...data.map(d => d.ppm));
const minPPM = Math.min(...data.map(d => d.ppm));
const range = maxPPM - minPPM || 1;
// Add 10% padding on both sides of range
const paddedMin = minPPM - range * 0.1;
const paddedMax = maxPPM + range * 0.1;
const paddedRange = paddedMax - paddedMin;

const points = data.map((d, i) => ({
  x: padLeft + (i / (data.length - 1)) * chartW,
  y: padTop + (1 - (d.ppm - paddedMin) / paddedRange) * chartH, // higher PPM = higher on chart
  ...d,
}));

const linePath = points.map((p, i) => (i === 0 ? `M ${p.x},${p.y}` : `L ${p.x},${p.y}`)).join(" ");
const areaPath = `${linePath} L ${points[points.length - 1].x},${padTop + chartH} L ${points[0].x},${padTop + chartH} Z`;

// Y-axis labels
const yTicks = 4;
const yLabels = Array.from({ length: yTicks + 1 }, (_, i) => {
  const val = paddedMin + (paddedRange * (yTicks - i)) / yTicks;
  return {
    y: padTop + (i / yTicks) * chartH,
    label: val.toFixed(1),
  };
});

const gridLines = yLabels.map(t => t.y);
---

<WidgetWrapper title="Speed Trend · Pieces per Minute" moreLink="https://myspeedpuzzling.com/player/simona-mikesova/stats" moreText="Full stats →">
  <!-- Summary row -->
  <div class="mb-4">
    <span class="font-display text-2xl font-bold text-slate-800">{data[data.length - 1].ppm}</span>
    <span class="text-xs text-slate-400 ml-1">ppm current avg</span>
  </div>

  <!-- SVG Chart -->
  <svg viewBox={`0 0 ${w} ${h}`} class="w-full" preserveAspectRatio="xMidYMid meet">
    <!-- Grid lines -->
    {gridLines.map(y => (
      <line x1={padLeft} y1={y} x2={w - padRight} y2={y} stroke="#f1f5f9" stroke-width="1" />
    ))}

    <!-- Y-axis labels -->
    {yLabels.map(t => (
      <text x={padLeft - 8} y={t.y + 4} text-anchor="end" fill="#94a3b8" font-size="11" font-family="Inter, sans-serif">{t.label}</text>
    ))}

    <!-- Area gradient -->
    <defs>
      <linearGradient id="ppmAreaGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#EC726F" stop-opacity="0.2" />
        <stop offset="100%" stop-color="#EC726F" stop-opacity="0.02" />
      </linearGradient>
    </defs>
    <path d={areaPath} fill="url(#ppmAreaGrad)" />

    <!-- Line -->
    <path d={linePath} fill="none" stroke="#EC726F" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />

    <!-- Data points -->
    {points.map((p) => (
      <circle cx={p.x} cy={p.y} r="4" fill="#EC726F" stroke="white" stroke-width="2" />
    ))}

    <!-- X-axis labels -->
    {points.map((p, i) => {
      const show = i === 0 || i === points.length - 1 || i % 2 !== 0;
      return show ? (
        <text x={p.x} y={h - 8} text-anchor="middle" fill="#94a3b8" font-size="10" font-family="Inter, sans-serif">{p.month}</text>
      ) : null;
    })}

    <!-- First and last value labels -->
    <text x={points[0].x} y={points[0].y - 10} text-anchor="start" fill="#94a3b8" font-size="10" font-family="JetBrains Mono, monospace">{data[0].ppm}</text>
    <text x={points[points.length - 1].x} y={points[points.length - 1].y - 10} text-anchor="end" fill="#EC726F" font-size="11" font-weight="600" font-family="JetBrains Mono, monospace">{data[data.length - 1].ppm}</text>
  </svg>
</WidgetWrapper>
